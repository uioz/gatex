<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>daemon</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.esm-browser.prod.js"
    integrity="sha256-9hkLUYH+c9hqvwfekYBHX2Oz+DRCJgSnS+wSwrF7mVw=" crossorigin="anonymous"></script>
</head>

<body>
  <div id="app">
    <form @submit.prevent="handleSubmit">
      <h2>添加服务</h2>
      <fieldset>
        <legend>类型:</legend>
        <div>
          <input type="radio" id="add-api" v-model="formData.type" value="api">
          <label for="add-api">api</label>
        </div>
        <div>
          <input type="radio" id="add-app" v-model="formData.type" value="app">
          <label for="add-app">app</label>
        </div>
      </fieldset>
      <fieldset>
        <legend>{{formData.type}}名称:</legend>
        <input type="input" id="add-label" v-model="formData.label">
        <p><em>注意:</em> app 可以通过 <code>@</code> 来创建通道, 映射到指定的 api, 例如 <code>dev@admin</code>, 此应用将会请求 <code>dev</code>
          服务</p>
      </fieldset>
      <fieldset v-if="formData.type === 'api'">
        <legend>服务地址(url):</legend>
        <input type="input" id="add-url" v-model="formData.url" placeholder="http(s)://">
        <p><em>注意:</em> 不填写端口号则通过名称来计算端口</p>
      </fieldset>
      <fieldset v-if="formData.type === 'app'">
        <legend>上传应用:</legend>
        <input type="file" id="app-file" name="add-file" accept="application/zip">
      </fieldset>
      <button>提交</button>
    </form>
    <h3>生效的服务名称</h3>
    <table>
      <thead>
        <tr>
          <th>类型</th>
          <th>服务名称</th>
          <th>服务地址(api only)</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="item in data" :key="key">
          <td>{{item.type}}</td>
          <td>{{item.label}}</td>
          <td>{{item.url}}</td>
          <td>
            <button @click="handleDelete(item)">删除</button>
            <clone-app v-if="item.type === 'api' && !item.hasApp" :api-name="item.label" :sources="apps"
              @success="refresh"></clone-app>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <script type="text/x-template" id="clone-app">
    <span>选择要克隆的应用</span>
    <select v-model="source">
      <option v-for="source of sources">{{source}}</option>
    </select>
    <span>克隆后应用名称</span>
    <input type="input" v-model="target">
    <button @click="handleClone">克隆</button>
  </script>
  <script type="module">
    import { createApp, ref, defineComponent, watch } from 'https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.esm-browser.prod.js'

    const cloneApp = defineComponent({
      props: ['sources', 'apiName'],
      emits: ['submit'],
      setup(props, { emit }) {

        const source = ref(props.sources[0]);
        const target = ref('');

        watch(source, (source) => {

          const [appNameFallback, appName] = source.split('@');

          if (appName) {
            target.value = `${props.apiName}@${appName}`;
          } else {
            target.value = props.apiName;
          }

        }, {
          immediate: true
        });

        return {
          source,
          target,
          async handleClone() {
            const { status } = await fetch(`/api/service/app/clone/${source.value}/${target.value}`, {
              method: "POST"
            });
            if (status === 200) {
              emit('success');
            } else {
              alert('克隆失败');
            }
          }
        }
      },
      template: '#clone-app'
    });

    function useData() {

      const data = ref();
      const apps = ref();

      return {
        data,
        apps,
        async refresh() {
          const response = await fetch('/api/service');
          const result = await response.json();

          const completedEnv = new Set();
          const appTemps = [];
          const apis = [];

          for (const item of result) {
            if (item.type === 'app') {
              completedEnv.add(item.label.split('@')[0]);
              appTemps.push(item.label);
            } else if (item.type === 'api') {
              apis.push(item)
            }
          }

          for (const api of apis) {
            api.hasApp = completedEnv.has(api.label)
          }

          data.value = result;
          apps.value = appTemps;
        }
      }

    }

    createApp({
      components: {
        cloneApp
      },
      setup() {

        const { data, apps, refresh } = useData();

        refresh();

        const formData = ref({
          type: 'api',
          label: '',
          url: ''
        });

        async function handleDelete(item) {
          const { status } = await fetch(`/api/service/${item.type}/${item.label}`, {
            method: "DELETE"
          });

          if (status === 200) {
            refresh();
          } else {
            alert('删除失败')
          }
        }

        async function handleSubmit() {

          const { type, url, label } = formData.value;

          let result;

          if (type === 'api') {
            result = await fetch(`/api/service/api/${label}?url=${url}`, {
              method: 'POST'
            });
          } else if (type === 'app') {
            result = await fetch(`/api/service/app/${label}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/zip'
              },
              body: document.getElementById('app-file').files[0],
            });
          }

          if (result.status === 200) {
            refresh();
          } else {
            alert('添加失败')
          }
        }

        return {
          data,
          apps,
          formData,
          handleDelete,
          handleSubmit
        }
      }
    }).mount('#app')

  </script>
</body>

</html>